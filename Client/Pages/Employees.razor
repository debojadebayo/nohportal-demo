@page "/employees"
@using ComposedHealthBase.BaseClient.Enums
@using ComposedHealthBase.BaseClient.Services
@using ComposedHealthBase.Shared.DTOs
@using ComposedHealthBase.BaseClient.Components
@using Shared.DTOs.CRM
@using Shared.DTOs.Scheduling
@using MudBlazor
@using Client.Pages.Components.TabComponents
@inject ILazyLookupService<EmployeeDto> EmployeeLookupService
@inject ILazyLookupService<CustomerDto> CustomerLookupService
@inject ILazyLookupService<ManagerDto> ManagerLookupService
@inject ILazyLookupService<ScheduleDto> ScheduleLookupService
@inject ILazyLookupService<ReferralDto> ReferralLookupService
@inject ILazyLookupService<ContractDto> ContractLookupService
@inject ILazyLookupService<EmployeeDocumentDto> DocumentLookupService
@inject IAuthHelperService AuthHelperService

@attribute [Authorize]

<MudText Typo="Typo.h1">Employees</MudText>

<MudText Typo="Typo.body1">Select an employee to view details</MudText>
<LazyLookup TDto="EmployeeDto" FieldType="LazyLookupEnum.Search" @bind-ItemId="selectedEmployeeId" Label="Employee Name"
    SelectedItemChanged="OnEmployeeSelected" />
@if (selectedEmployee == null)
{
    <MudButton OnClick="CreateEmployee">Add New Employee</MudButton>
}

@if (selectedEmployee != null)
{
    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" @ref="tabs">
        <MudTabPanel Text="Employee">
            <EmployeeDetailsTab Model="selectedEmployee" OnSave="HandleEmployeeSave" OnDelete="DeleteEmployee" />
        </MudTabPanel>
        <MudTabPanel Text="Appointments" OnClick="GetAllAppointmentsByEmployeeId">
            <AppointmentsTab Appointments="appointments" />
        </MudTabPanel>
        <MudTabPanel Text="Referrals" OnClick="GetAllReferralsByEmployeeId">
            <ReferralsTab Referrals="referrals" CustomerId="selectedEmployee.CustomerId" EmployeeId="selectedEmployee.Id"
                OnSave="HandleReferralSave" />
        </MudTabPanel>
        <MudTabPanel Text="Managers" OnClick="GetAllManagersByEmployeeId">
            <ManagersTab Managers="managers" />
        </MudTabPanel>
        <MudTabPanel Text="Documents" OnClick="GetAllDocumentsByEmployeeId">
            <DocumentBrowser TDto="EmployeeDocumentDto" @bind-DocumentIds="selectedEmployee.RelatedDocumentIds"
                OnDocumentUploaded="() => HandleEmployeeSave(selectedEmployee)" />
        </MudTabPanel>
        <MudTabPanel Text="Notes">
            <NotesTab Model="selectedEmployee" OnSave="HandleEmployeeSave" TDto="EmployeeDto" />
        </MudTabPanel>
    </MudTabs>
}


@code {
    private MudTabs tabs = default!;
    private List<ScheduleDto> appointments = new();
    private List<ReferralDto> referrals = new();
    private List<ManagerDto> managers = new();
    private List<EmployeeDocumentDto> documents = new();
    private EmployeeDocumentDto newDocument = default!;
    private Guid selectedEmployeeId = Guid.Empty;
    private EmployeeDto? selectedEmployee = default!;
    private bool newEmployee = false;
    private void CreateEmployee()
    {
        selectedEmployee = new EmployeeDto();
        newEmployee = true;
    }
    private async Task HandleEmployeeSave(EmployeeDto employee)
    {
        if (newEmployee && employee != null)
        {
            selectedEmployee = await AuthHelperService.CreateSubject<EmployeeDto>(employee, CancellationToken.None)!;
            newEmployee = false;
            return;
        }
        await EmployeeLookupService.UpdateItem(employee, CancellationToken.None);
    }
    async Task DeleteEmployee()
    {
        if (selectedEmployee == null) return;
        await EmployeeLookupService.DeleteItem(selectedEmployee.Id, CancellationToken.None);
    }
    private async Task GetAllAppointmentsByEmployeeId()
    {
        if (selectedEmployee == null) return;
        appointments = (await ScheduleLookupService.GetAllBySubjectId(selectedEmployee.Id, CancellationToken.None)).ToList();
    }
    private async Task GetAllReferralsByEmployeeId()
    {
        if (selectedEmployee == null) return;
        referrals = (await ReferralLookupService.GetAllBySubjectId(selectedEmployee.Id, CancellationToken.None)).ToList();
    }
    private async Task GetAllManagersByEmployeeId()
    {
        if (selectedEmployee == null) return;
        managers = (await ManagerLookupService.GetAllBySubjectId(selectedEmployee.Id, CancellationToken.None)).ToList();
    }
    private async Task GetAllDocumentsByEmployeeId()
    {
        if (selectedEmployee == null) return;
        documents = (await DocumentLookupService.GetAllBySubjectId(selectedEmployee.Id, CancellationToken.None)).ToList();
        newDocument = new EmployeeDocumentDto
        {
            Name = ""
        };
    }
    private async Task OnDocumentSave()
    {
        if (selectedEmployeeId == null) return;
        documents = (await DocumentLookupService.GetAllBySubjectId(selectedEmployeeId, CancellationToken.None)).ToList();
        newDocument = new EmployeeDocumentDto
        {
            Name = ""
        };
    }
    private void OnEmployeeSelected(EmployeeDto employee)
    {
        selectedEmployee = employee;

    }
    private async Task HandleReferralSave(ReferralDto referral)
    {
        if (referral == null) return;
        if (referral.Id == Guid.Empty)
        {
            await ReferralLookupService.AddItem(referral, CancellationToken.None);
        }
        else
        {
            await ReferralLookupService.UpdateItem(referral, CancellationToken.None);
        }
        await GetAllReferralsByEmployeeId();
    }
}
