@page "/"
@using Client.Pages.Components
@using Microsoft.AspNetCore.Authorization
@using Shared.DTOs.CRM
@using Client.Pages.Components.Calendar
@using Shared.DTOs.Scheduling
@inject IHttpClientFactory HttpClientFactory
@* @attribute [Authorize] *@

<PageTitle>Diary</PageTitle>

<MudText Typo="Typo.h1">Diary</MudText>

<MultiResourceCalendar Resources="@Resources" />

@code {
    private IEnumerable<ClinicianDto> Clinicians { get; set; } = new List<ClinicianDto>();
    private Dictionary<long, List<CustomCalendarItem<ScheduleDto>>> Resources { get; set; } = new Dictionary<long, List<CustomCalendarItem<ScheduleDto>>>();
    private HttpClient? httpClient;

    protected override async Task OnInitializedAsync()
	{
		try
		{
			httpClient = HttpClientFactory.CreateClient("api");

			Clinicians = await httpClient.GetFromJsonAsync<IEnumerable<ClinicianDto>>("api/clinician/getall");
			if (Clinicians == null) return;
            Resources = Clinicians.ToDictionary(
                c => c.Id,
                c => c.Schedules.Select(s => new CustomCalendarItem<ScheduleDto>
                {
                    Data = s
                }).ToList()
            );
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error fetching Clinician data: {ex.Message}");
		}
	}
}