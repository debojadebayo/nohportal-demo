@namespace Client.Pages.Components.TabComponents
@using Shared.DTOs
@using MudBlazor
@using Shared.DTOs.CRM

<MudPaper Class="pa-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
        <MudText Typo="Typo.h6">Products</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ShowAddProductDialog"
            StartIcon="@Icons.Material.Filled.Add">Add Product</MudButton>
    </MudStack>
    <MudDataGrid T="ProductDto" Items="Products ?? new List<ProductDto>()" Dense="true" Hover="true" Striped="true"
        Bordered="true" Filterable="true">
        <Columns>
            <PropertyColumn Property="x => x.Id" Title="Product ID" />
            <PropertyColumn Property="x => x.ProductType.Description" Title="Description" />
            <PropertyColumn Property="x => x.ProductType.ChargeCode" Title="Charge Code" />
            <PropertyColumn Property="x => x.StartTime" Title="Start Date">
                <CellTemplate>
                    @context.Item.StartTime?.ToString("dd/MM/yyyy")
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.EndTime" Title="End Date">
                <CellTemplate>
                    @context.Item.EndTime?.ToString("dd/MM/yyyy")
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="@(x => $"Â£{x.Price}")" />
        </Columns>
        <NoRecordsContent>
            <MudText>No products found.</MudText>
        </NoRecordsContent>
    </MudDataGrid>
</MudPaper>

<MudDialog @bind-Visible="_addProductDialogOpen" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Add New Product</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="productForm" Model="NewProduct">
            <MudSelect T="ProductTypeDto" Label="Product Type" @bind-Value="_selectedProductType">
                @foreach (var pt in ProductTypes)
                {
                    <MudSelectItem Value="pt">@pt.DisplayName</MudSelectItem>
                }
            </MudSelect>
            <MudNumericField @bind-Value="NewProduct.Price" Label="Price" Variant="Variant.Outlined" />
            <MudDatePicker @bind-Date="NewProduct.StartTime" DateFormat="dd/MM/yyyy" Label="Start Date" />
            <MudDatePicker @bind-Date="NewProduct.EndTime" DateFormat="dd/MM/yyyy" Label="End Date" />
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="AddProduct">Add Product</MudButton>
        <MudButton OnClick="CancelProduct">Cancel</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public IEnumerable<ProductDto> Products { get; set; } = new List<ProductDto>();
    [Parameter] public IEnumerable<ProductTypeDto> ProductTypes { get; set; } = new List<ProductTypeDto>();
    [Parameter] public EventCallback<ProductDto> OnProductSave { get; set; }
    [Parameter] public EventCallback OnProductCancel { get; set; }
    [Parameter] public ProductDto NewProduct { get; set; } = default!;
    private DialogOptions _dialogOptions = new() { MaxWidth = MaxWidth.Medium, FullWidth = true };
    private bool _addProductDialogOpen = false;
    private MudForm productForm = default!;
    private ProductTypeDto? _selectedProductType;

    private void ShowAddProductDialog()
    {
        _addProductDialogOpen = true;
    }

    private async Task AddProduct()
    {
        await productForm.Validate();
        if (!productForm.IsValid) return;
        if (_selectedProductType != null)
        {
            NewProduct.ProductType = _selectedProductType;
        }
        await OnProductSave.InvokeAsync(NewProduct);
        _addProductDialogOpen = false;
    }

    private async Task CancelProduct()
    {
        _addProductDialogOpen = false;
        if (OnProductCancel.HasDelegate)
            await OnProductCancel.InvokeAsync();
    }
}
