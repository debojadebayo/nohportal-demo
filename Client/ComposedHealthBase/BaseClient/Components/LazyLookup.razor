@namespace ComposedHealthBase.BaseClient.Components
@using ComposedHealthBase.BaseClient.Services
@using ComposedHealthBase.BaseClient.Enums
@using ComposedHealthBase.Shared.Interfaces
@using System.Linq.Expressions
@typeparam TDto where TDto : ILazyLookup
@inject ILazyLookupService<TDto> LookupService

@switch (FieldType)
{
    case LazyLookupEnum.Text:
        <MudText>@(SelectedItem?.DisplayName ?? "(Not set)")</MudText>
        break;
    case LazyLookupEnum.Search:
        <MudAutocomplete T="Guid" ToStringFunc="@LookupService.ItemToString" Label="@Label" Value="@ItemId"
            ValueChanged="@OnItemChanged" SearchFunc="@LookupService.ItemSearch" ShowProgressIndicator="true"
            ProgressIndicatorColor="Color.Default" />
        break;
    case LazyLookupEnum.Select:
        <MudSelect @bind-Value="ItemId" Label="@Label">
            @foreach (var item in _items)
            {
                <MudSelectItem Value="item.Id">@item.DisplayName</MudSelectItem>
            }
        </MudSelect>
        break;
    default:
        <MudText>(Not set)</MudText>
        break;
}

@code {
    [Parameter] public LazyLookupEnum FieldType { get; set; } = LazyLookupEnum.Text;
    [Parameter] public Guid ItemId { get; set; } = Guid.Empty;
    [Parameter] public string Label { get; set; } = "";
    [Parameter] public EventCallback<Guid> ItemIdChanged { get; set; }
    [Parameter] public Expression<Func<Guid>>? ItemIdValueExpression { get; set; }
    public TDto? SelectedItem { get; set; }
    private List<TDto> _items = new List<TDto>();
    protected override async Task OnParametersSetAsync()
    {
        if (ItemId != null)
        {
            SelectedItem = await LookupService.GetItemById(ItemId, CancellationToken.None);
        }
        else
        {
            SelectedItem = default;
        }
        if (FieldType == LazyLookupEnum.Select)
        {
            _items = (await LookupService.GetAllItems(CancellationToken.None)).ToList();
        }
        StateHasChanged();
    }
    private async Task OnItemChanged(Guid value)
    {
        if (value != Guid.Empty)
        {
            SelectedItem = await LookupService.GetItemById(value, CancellationToken.None);
        }
        else
        {
            SelectedItem = default;
        }
        ItemId = value;
        await ItemIdChanged.InvokeAsync(value);
        StateHasChanged();
    }
}
